name: Pull locales from POEditor

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */12 * * *"

permissions:
  contents: write
  pull-requests: write

jobs:
  pull-locales:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Debug Variables
        run: |
          echo "Languages to pull: ${{ vars.POEDITOR_LANGUAGES }}"

      - name: Pull locales from POEditor
        run: node .github/scripts/pull-poeditor.mjs
        env:
          POEDITOR_API_TOKEN: ${{ secrets.POEDITOR_API_TOKEN }}
          POEDITOR_PROJECT_ID: ${{ secrets.POEDITOR_PROJECT_ID }}
          POEDITOR_LANGUAGES: ${{ vars.POEDITOR_LANGUAGES }}
          POEDITOR_EXPORT_TYPE: key_value_json

      - name: Verify locales
        run: npm run verify-locales

      - name: Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: pull locales from POEditor"
          branch: "locales/update-from-poeditor"
          delete-branch: true
          title: "chore: update locales from POEditor"
          body: |
            Automated update of locale files from POEditor.

            This PR matches the contents of the localization files with the latest export from POEditor.
          labels: |
            automated pr
            localization

      - name: Enable Pull Request Automerge
        if: steps.cpr.outputs.pull-request-operation == 'created'
        run: gh pr merge --merge --auto "${{ steps.cpr.outputs.pull-request-number }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
